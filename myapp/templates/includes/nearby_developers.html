{% load static %}
{% load custom_filter %}

{# Nearby Developers - GitHub Style Card Design #}
{% if nearby_developers %}
<div class="nearby-developers-section w-full">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4 px-1">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-location-dot text-[#58a6ff] text-xs"></i>
            <p class="text-xs font-semibold text-[#e6edf3]">Nearby developers</p>
        </div>
        {% if nearby_developers|length >= 5 %}
        <a href="{% url 'explore' %}?tab=nearby" class="text-[11px] text-[#58a6ff] hover:underline font-medium">See all</a>
        {% endif %}
    </div>
    
    <!-- Horizontal Scroll (Mobile/Tablet) | Column List (Desktop) -->
    <div class="flex gap-3 overflow-x-auto pb-3 scrollbar-thin scrollbar-thumb-[#30363d] scrollbar-track-transparent snap-x snap-mandatory
                min-[1110px]:flex-col min-[1110px]:overflow-visible min-[1110px]:pb-0 min-[1110px]:gap-0">
        {% for developer, distance in nearby_developers %}
        <div class="group w-[160px] flex-shrink-0 snap-start bg-[#161b22] border border-[#30363d] rounded-xl p-4 
                    hover:border-[#58a6ff]/50 hover:bg-[#1c2128] transition-all duration-200
                    flex flex-col items-center text-center
                    min-[1110px]:w-auto min-[1110px]:flex-shrink min-[1110px]:flex-row min-[1110px]:items-center min-[1110px]:text-left min-[1110px]:p-2.5 min-[1110px]:px-1
                    min-[1110px]:bg-transparent min-[1110px]:border-0 min-[1110px]:border-b min-[1110px]:border-[#21262d] min-[1110px]:rounded-none
                    min-[1110px]:hover:bg-[#161b22] min-[1110px]:last:border-b-0">
            
            <!-- Avatar -->
            <a href="{% url 'user_profile' developer.user.username %}" 
               class="block mb-3 min-[1110px]:mb-0 min-[1110px]:mr-3 flex-shrink-0">
                <img src="{{ developer.profile_image.url }}?v={{ developer.updated_at.timestamp }}" 
                     alt="{{ developer.user.username }}"
                     class="w-14 h-14 min-[1110px]:w-9 min-[1110px]:h-9 rounded-full border-2 border-[#30363d] 
                            group-hover:border-[#58a6ff]/50 object-cover transition-colors min-[1110px]:border">
            </a>
            
            <!-- Info -->
            <div class="flex-1 min-w-0 w-full min-[1110px]:w-auto">
                <!-- Username -->
                <a href="{% url 'user_profile' developer.user.username %}" 
                   class="block text-sm font-semibold text-[#e6edf3] hover:text-[#58a6ff] truncate transition-colors mb-1 min-[1110px]:text-[13px] min-[1110px]:mb-0">
                    {{ developer.user.username }}
                </a>
                
                <!-- Distance Badge (Mobile/Tablet only) -->
                <div class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-[#0d1117] border border-[#30363d] min-[1110px]:hidden">
                    <i class="fa-solid fa-location-dot text-[9px] text-[#58a6ff]"></i>
                    <span class="text-[10px] font-medium text-[#8b949e]">
                        {% if distance < 1 %}&lt;1{% elif distance < 10 %}{{ distance|floatformat:1 }}{% else %}{{ distance|floatformat:0 }}{% endif %} km
                    </span>
                </div>
                
                <!-- Distance Text (Desktop only) -->
                <span class="hidden min-[1110px]:inline text-[11px] text-[#8b949e]">
                    {% if distance < 1 %}&lt;1{% elif distance < 10 %}{{ distance|floatformat:1 }}{% else %}{{ distance|floatformat:0 }}{% endif %} km away
                </span>
            </div>
            
            <!-- Follow Button -->
            <div class="mt-3 w-full min-[1110px]:mt-0 min-[1110px]:w-auto min-[1110px]:ml-2 flex-shrink-0">
                {% with is_following=request.user.info|is_following:developer %}
                {% if is_following %}
                <button onclick="toggleNearbyFollow('{{ developer.id }}', this)" 
                        class="w-full min-[1110px]:w-auto px-4 py-1.5 text-xs font-medium text-[#c9d1d9] bg-[#21262d] 
                               border border-[#363b42] rounded-md hover:bg-[#30363d] hover:border-[#8b949e] transition-all
                               min-[1110px]:px-3 min-[1110px]:py-1">
                    Following
                </button>
                {% else %}
                <button onclick="toggleNearbyFollow('{{ developer.id }}', this)" 
                        class="w-full min-[1110px]:w-auto px-4 py-1.5 text-xs font-semibold text-white bg-[#238636] 
                               border border-[#238636] rounded-md hover:bg-[#2ea043] transition-all shadow-sm
                               min-[1110px]:px-3 min-[1110px]:py-1">
                    Follow
                </button>
                {% endif %}
                {% endwith %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<!-- Empty State -->
{% if show_empty_state %}
<div class="nearby-developers-section w-full">
    <div class="flex items-center gap-2 mb-4 px-1">
        <i class="fa-solid fa-location-dot text-[#484f58] text-xs"></i>
        <p class="text-xs font-semibold text-[#6e7681]">Nearby developers</p>
    </div>
    
    <div class="p-6 rounded-xl bg-[#161b22] border border-[#30363d] text-center">
        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-[#21262d] flex items-center justify-center">
            <i class="fa-solid fa-location-crosshairs text-lg text-[#484f58]"></i>
        </div>
        <p class="text-sm text-[#8b949e]">
            {% if not request.user.info.latitude %}
            Enable location to discover nearby developers
            {% else %}
            No developers found nearby
            {% endif %}
        </p>
    </div>
</div>
{% endif %}
{% endif %}

<!-- Nearby Developers Follow Script -->
{% if nearby_developers %}
<script>
// Toggle follow for nearby developers
async function toggleNearbyFollow(userId, button) {
    const isFollowing = button.textContent.trim() === 'Following';
    
    button.disabled = true;
    const originalText = button.textContent;
    const originalClass = button.className;
    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-xs"></i>';
    
    try {
        const url = isFollowing ? `/unfollow/${userId}/` : `/follow/${userId}/`;
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getNearbyCSRF(),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            if (isFollowing) {
                button.textContent = 'Follow';
                button.className = 'w-full min-[1110px]:w-auto px-4 py-1.5 text-xs font-semibold text-white bg-[#238636] border border-[#238636] rounded-md hover:bg-[#2ea043] transition-all shadow-sm';
            } else {
                button.textContent = 'Following';
                button.className = 'w-full min-[1110px]:w-auto px-4 py-1.5 text-xs font-medium text-[#c9d1d9] bg-[#21262d] border border-[#363b42] rounded-md hover:bg-[#30363d] hover:border-[#8b949e] transition-all';
            }
        } else {
            throw new Error('Action failed');
        }
    } catch (error) {
        console.error('Follow error:', error);
        button.textContent = originalText;
        button.className = originalClass;
    } finally {
        button.disabled = false;
    }
}

function getNearbyCSRF() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === 'csrftoken=') {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endif %}

{% load static %}
{% load custom_filter %}
{% load comment_tags %}

{% for log in feed_items %}
<div id="log-{{ log.sig }}" data-log-sig="{{ log.sig }}" class="bg-[#151b23] border border-[#21262d] rounded-xl overflow-hidden hover:border-[#30363d] transition-all duration-200 shadow-lg relative {% if highlighted_log_sig == log.sig %}highlighted-from-{{ source }}{% endif %}">
    
    <!-- Suggestion Label - Only for Secondary Network (LinkedIn/Instagram style) -->
    {% if log.recommendation_reason %}
    <div class="px-4 py-2 bg-[#13171d] border-b border-gray-800 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <i class="fa {{ log.recommendation_reason.icon }} text-[11px] text-gray-500"></i>
            <span class="text-[11px] text-gray-400">
                {{ log.recommendation_reason.text|linkify_usernames|safe }}
            </span>
            {% if log.recommendation_reason.subtext %}
            <span class="text-[10px] text-gray-500">¬∑ {{ log.recommendation_reason.subtext }}</span>
            {% endif %}
        </div>
        <!-- Quick Follow/Unfollow Toggle Button for Secondary Network -->
        {% with is_following=request.user.info|is_following:log.user %}
        {% if is_following %}
        {% comment %} <button onclick="quickFollowUser('{{ log.user.user.username }}', this)" 
                data-username="{{ log.user.user.username }}"
                data-following="true"
                class="quick-follow-btn text-xs px-3 py-1 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600 transition-colors font-medium border border-gray-600">
            <i class="fa fa-check"></i> Following
        </button> {% endcomment %}
        {% else %}
        <button onclick="quickFollowUser('{{ log.user.user.username }}', this)" 
                data-username="{{ log.user.user.username }}"
                data-following="false"
                class="quick-follow-btn text-xs px-3 py-1 bg-[#238636] text-white rounded-md hover:bg-[#2ea043] transition-colors font-medium border border-[rgba(240,246,252,0.1)] shadow-sm">
            Follow
        </button>
        {% endif %}
        {% endwith %}
    </div>
    {% endif %}
    
    <!-- User Header -->
    <div class="flex items-center gap-3 p-4 bg-[#151b23] border-b border-[#282e35]">
        <a href="{% url 'user_profile' log.user.user.username %}">
            <img src="{{ log.user.profile_image.url|default:'/static/assets/default-avatar.png' }}" 
                 alt="{{ log.user.user.username }}"
                 class="w-10 h-10 rounded-full object-cover ring-2 ring-[#30363d] hover:ring-green-500 transition-all">
        </a>
        <div class="flex-1">
            <a href="{% url 'user_profile' log.user.user.username %}" 
               class="text-sm font-semibold text-gray-200 hover:text-green-400 transition-colors">
                {{ log.user.user.username }}
            </a>
            <div class="flex items-center gap-2 text-xs text-gray-500 font-mono">
                <i class="fa fa-clock-o text-[10px]"></i>
                <span>{{ log.timestamp|timesince }} ago</span>
            </div>
        </div>
        {% if log.user == request.user.info %}
        <button class="delete-log-btn text-gray-500 hover:text-red-400 transition-colors p-1" data-log-id="{{ log.sig }}">
            <i class="fa fa-trash text-xs"></i>
        </button>
        {% endif %}
    </div>

    <!-- Log Content -->
    <div class="p-4 space-y-3">
        <div class="flex items-start gap-2">
            <span class="text-green-400 mt-0.5 text-sm flex-shrink-0">&gt;_</span>
            <p class="text-gray-200 text-sm leading-relaxed font-mono flex-1">{{ log.content|parse_mentions }}</p>
        </div>

        <!-- Snapshot image -->
        {% if log.snap_shot %}
        <div class="mt-3">
            <img src="{{ log.snap_shot.url }}" 
                 alt="Log snapshot" 
                 onclick="previewImage('{{ log.snap_shot.url }}')"
                 class="w-48 h-48 object-cover rounded-md border border-[#21262d] cursor-pointer hover:opacity-90 transition-opacity duration-200 shadow-md">
        </div>
        {% endif %}

        <!-- Code snippet -->
        {% if log.code_snippet %}
        <div class="relative code-snippet-container bg-[#0a0e14] border border-[#21262d] rounded-md mt-3">
            <div class="flex items-center justify-between -mb-2 pt-3 px-3">
                <span class="text-[10px] text-gray-500 font-mono uppercase tracking-wider">Code</span>
                <button onclick="copySnippet('{{ log.sig }}')" 
                        class="text-gray-500 hover:text-green-400 transition-colors">
                    <i class="fa fa-copy text-xs"></i>
                </button>
            </div>
            <pre id="code-snippet-{{ log.sig }}" class="m-0 overflow-x-auto overflow-y-auto max-h-90 text-xs leading-relaxed"><code class="font-mono">{{ log.code_snippet }}</code></pre>
        </div>
        {% endif %}

        <!-- Link -->
        {% if log.link %}
        <a href="{{ log.link }}" 
           target="_blank" 
           class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-colors text-xs font-mono mt-2">
            <i class="fa fa-link text-[10px]"></i>
            <span class="truncate">{{ log.link }}</span>
            <i class="fa fa-external-link text-[8px]"></i>
        </a>
        {% endif %}
    </div>

    <!-- Reactions and Comments Row -->
    <div class="flex items-center justify-between px-4 py-3 border-t border-[#21262d]/50 relative">

        <!-- Left Side: Reaction Picker + Active Reactions -->
        <div class="flex items-center gap-2">
            <!-- Add Reaction Button -->
            <button onclick="toggleReactionPicker('{{ log.sig }}')" 
                    class="add-reaction-btn text-gray-500 hover:text-blue-400 hover:cursor-pointer transition-colors p-1 rounded-md hover:bg-[#1f242c]">
                <i class="fa fa-smile-o text-base"></i>
            </button>

            <!-- Reaction Picker (Absolute) -->
            <div id="picker-{{ log.sig }}" class="reaction-picker hidden absolute bottom-full left-4 mb-2 bg-[#161b22] border border-[#30363d] rounded-lg shadow-xl p-2 gap-1 z-50">
                <button onclick="toggleReaction('{{ log.sig }}', '‚ù§Ô∏è')" class="hover:bg-[#1f242c] p-1.5 rounded transition-colors text-sm">‚ù§Ô∏è</button>
                <button onclick="toggleReaction('{{ log.sig }}', 'üöÄ')" class="hover:bg-[#1f242c] p-1.5 rounded transition-colors text-sm">üöÄ</button>
                <button onclick="toggleReaction('{{ log.sig }}', 'üí°')" class="hover:bg-[#1f242c] p-1.5 rounded transition-colors text-sm">üí°</button>
                <button onclick="toggleReaction('{{ log.sig }}', 'üò¢')" class="hover:bg-[#1f242c] p-1.5 rounded transition-colors text-sm">üò¢</button>
            </div>

            <!-- Active Reactions List -->
            <div id="reactions-{{ log.sig }}" class="flex items-center gap-2">
            {% with user_reaction=log|args:request.user|call:"get_user_reaction" %}
                
                <!-- Like -->
                <button onclick="toggleReaction('{{ log.sig }}', '‚ù§Ô∏è')" 
                        class="reaction-btn group relative flex items-center gap-1 px-2 py-1 rounded-md text-xs font-mono transition-all duration-200
                               {% if user_reaction and user_reaction.emoji == '‚ù§Ô∏è' %}
                                   bg-blue-500/10 text-blue-400 border border-blue-500/30
                               {% else %}
                                   bg-[#0d1117] text-gray-500 border border-[#21262d] hover:border-gray-600 hover:text-gray-300
                               {% endif %}
                               {% if not log.get_reaction_counts|get_item:'‚ù§Ô∏è' %}hidden{% endif %}"
                        data-emoji="‚ù§Ô∏è">
                    <span>‚ù§Ô∏è</span>
                    <span class="count ml-0.5">
                        {{ log.get_reaction_counts|get_item:'‚ù§Ô∏è'|default:0 }}
                    </span>
                </button>

                <!-- Rocket -->
                <button onclick="toggleReaction('{{ log.sig }}', 'üöÄ')" 
                        class="reaction-btn group relative flex items-center gap-1 px-2 py-1 rounded-md text-xs font-mono transition-all duration-200
                               {% if user_reaction and user_reaction.emoji == 'üöÄ' %}
                                   bg-blue-500/10 text-blue-400 border border-blue-500/30
                               {% else %}
                                   bg-[#0d1117] text-gray-500 border border-[#21262d] hover:border-gray-600 hover:text-gray-300
                               {% endif %}
                               {% if not log.get_reaction_counts|get_item:'üöÄ' %}hidden{% endif %}"
                        data-emoji="üöÄ">
                    <span>üöÄ</span>
                    <span class="count ml-0.5">
                        {{ log.get_reaction_counts|get_item:'üöÄ'|default:0 }}
                    </span>
                </button>

                <!-- Insight -->
                <button onclick="toggleReaction('{{ log.sig }}', 'üí°')" 
                        class="reaction-btn group relative flex items-center gap-1 px-2 py-1 rounded-md text-xs font-mono transition-all duration-200
                               {% if user_reaction and user_reaction.emoji == 'üí°' %}
                                   bg-blue-500/10 text-blue-400 border border-blue-500/30
                               {% else %}
                                   bg-[#0d1117] text-gray-500 border border-[#21262d] hover:border-gray-600 hover:text-gray-300
                               {% endif %}
                               {% if not log.get_reaction_counts|get_item:'üí°' %}hidden{% endif %}"
                        data-emoji="üí°">
                    <span>üí°</span>
                    <span class="count ml-0.5">
                        {{ log.get_reaction_counts|get_item:'üí°'|default:0 }}
                    </span>
                </button>

                <!-- Sad -->
                <button onclick="toggleReaction('{{ log.sig }}', 'üò¢')" 
                        class="reaction-btn group relative flex items-center gap-1 px-2 py-1 rounded-md text-xs font-mono transition-all duration-200
                               {% if user_reaction and user_reaction.emoji == 'üò¢' %}
                                   bg-blue-500/10 text-blue-400 border border-blue-500/30
                               {% else %}
                                   bg-[#0d1117] text-gray-500 border border-[#21262d] hover:border-gray-600 hover:text-gray-300
                               {% endif %}
                               {% if not log.get_reaction_counts|get_item:'üò¢' %}hidden{% endif %}"
                        data-emoji="üò¢">
                    <span>üò¢</span>
                    <span class="count ml-0.5">
                        {{ log.get_reaction_counts|get_item:'üò¢'|default:0 }}
                    </span>
                </button>

            {% endwith %}
            </div>
        </div>

        <!-- Right Side: Comment Toggle Button -->
        <button onclick="toggleComments('{{ log.sig }}')" 
                class="flex items-center gap-2 text-gray-500 hover:text-green-400 transition-colors text-sm">
            <i class="fa-regular fa-message text-base"></i>
            <span id="comment-count-{{ log.sig }}">{{ log.total_comments }}</span>
            <span class="hidden sm:inline">{{ log.total_comments|pluralize:"comment,comments" }}</span>
        </button>
    </div>

    <!-- Comments Section -->
    {% include 'logs/partials/comment_section.html' with log=log home_feed=True%}

</div>

<!-- Nearby Developers (Mobile/Tablet Only - Local Tab) - After first batch of logs -->
{% if forloop.counter == 2 and feed_type == 'local' and nearby_developers %}
<div class="block min-[1110px]:hidden">
    {% include 'includes/nearby_developers.html' %}
</div>
{% endif %}

{% endfor %}

{% if not feed_items %}
<div class="text-center py-12 text-gray-500">
    <i class="fa fa-inbox text-3xl mb-3 opacity-30"></i>
    <p class="text-sm">No logs in your feed yet</p>
</div>
{% endif %}

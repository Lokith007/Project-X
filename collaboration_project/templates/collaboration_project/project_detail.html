{% extends "myapp/base.html" %} 
{% load static %}
{% load custom_filter %}

{% block title %}DevMate{% endblock %} 
{% block style %}<link rel="stylesheet" href="{% static 'styles/user_profile_page.css' %}"/>{% endblock %} 
{% block body_class %}text-[15px] h-full bg-[#0e1217] text-[#a8b3cf] overflow-x-hidden{% endblock %}

{% block content %}

    <!-- navbar -->
    {% include "includes/navbar.html" %}

    <div id = 'entireSection' class="mt-20 w-full px-10 md:px-2 max-[500px]:px-3 pb-20 flex flex-col gap-y-10">

        <a href="{% url 'explore-project' %}" class="w-fit transition bg-gradient-to-br from-green-600 to-green-900 hover:from-green-500 hover:to-green-800 border border-green-600 hover:border-green-500 text-white right-3 mt-1 flex items-center gap-x-2 px-4 py-2 rounded-lg shadow-lg hover:shadow-xl"><i class="fa-solid fa-arrow-left"></i> <span class="hidden md:block">Explore More...</span></a>

        <div class="flex gap-x-5 flex-col md:flex-row gap-y-10 -mt-5">
            <div class="bg-[#1a1f2b] border border-[#2d323b] p-6 rounded-xl w-full md:w-3/5 flex flex-col gap-y-5 shadow-xl">
                <div class="flex items-center gap-x-5">
                    <div>
                        <img src="{{project.creator.profile_image.url}}?v={{project.creator.updated_at.timestamp}}" alt="" class="w-14 h-14 rounded-lg border border-[#2d323b]">
                    </div>
                    <div class="flex flex-col gap-y-2">
                        <div class="text-gray-300"><span>Issued by</span> <span class="text-green-400 font-mono text-xs lg:text-sm">@{{project.creator.user.username}}</span></div>
                        <div class="text-gray-500 text-sm">{{project.created_at|date:"F j, Y" }}</div>
                    </div>
                    <div class="bookmarkBtnProject cursor-pointer bookmark-container-project text-gray-400 ml-auto transition-colors" data-project-id = "{{ project.id }}">
                        <i class="text-xl fa-solid fa-bookmark {% if project in user.info.saved_items.project.all %}text-green-400{% endif %}"></i>
                    </div>
                    <button onclick='copyCurrentURL()' class='cursor-pointer'>
                        <i class="fa fa-share-alt text-gray-400 hover:text-white text-2xl transition-colors"aria-hidden="true"></i>
                    </button>
                </div>
                <div class="flex flex-col gap-y-5">
                    <div class="flex flex-col gap-y-2">
                        <div class='flex gap-x-4 items-center'>
                            <div class="font-bold text-lg sm:text-3xl text-white break-words max-w-full">
                                {{ project.title }}
                            </div>
                            {% if project.creator == request.user.info %}
                            <a href='{% url "project_form" project.uuid %}' class="flex-shrink-0 flex items-center">
                                <img src='{% static "assets/pencil.svg" %}' class='h-5 w-5 min-w-5 min-h-5 filter invert' style="min-width: 20px; min-height: 20px;">
                            </a>
                            {% endif %}
                        </div>
                        
                        <div class="flex gap-x-3 items-center mt-2"> 
                            {% if project.url %}
                            <a href='{{project.url}}' target='_blank'><i class="text-2xl cursor-pointer fa-solid fa-globe text-gray-400 hover:text-white transition-colors"></i></a>
                            {% endif %}w
                            {% if project.github_link %}
                            <a href='{{project.github_link}}' target='_blank'><i class="text-2xl cursor-pointer fa-brands fa-github text-gray-400 hover:text-white transition-colors"></i></a>
                            {% endif %}
                        </div>

                        <div class='mt-4'>
                            <img src="{{project.image.url}}" alt="" class='rounded-lg border border-[#2d323b]'>
                        </div>
                    </div>
                    <div class="text-justify break-words text-gray-300 leading-relaxed" style="white-space: pre-wrap;">
                        {{project.description|linebreaksbr}}
                    </div>
                    
                    
                    {% if project.file or project.video %}
                    <div class='flex gap-x-2 items-center pt-3 '>
                        <img src = '{% static "assets/link.svg" %}' class='w-4 h-4 filter invert'>
                        <p class='text-lg text-green-400 underline underline-offset-2'>Learn More About This Project</p>
                    </div>
                        {% if project.file %}
                        <a href='{{project.file.url}}' target='_blank' class='flex flex-row gap-x-2 items-center hover:bg-green-600/20 border border-green-600 rounded-lg hover:text-green-300 px-4 py-2 bg-gradient-to-br from-green-600 to-green-900 text-white transition text-center w-fit shadow-lg'>
                            <img src = '{% static "assets/file.svg" %}' class='w-4 h-4 filter invert'>
                            <p class="">File</p>
                        </a>
                        {% endif %}                            
                        {% if project.video %}
                        <video width="320" height="240" controls class='pb-4 rounded-lg border border-[#2d323b]' >
                            <source src="{{project.video.url}}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>  
                    {% endif %}
                    {% endif %}
                    
                </div>
            </div>

            <div class="w-full md:w-2/5 flex flex-col gap-y-5 items-start">
                <div class="flex flex-col gap-y-4 border border-[#2d323b] bg-[#1a1f2b] p-6 rounded-xl relative w-full shadow-xl">
                    {% if project.type %}
                    <div class="absolute right-3 -top-3 text-sm font-bold text-center bg-gradient-to-br from-green-600 to-green-900 text-white px-3 py-2 rounded-lg shadow-lg">{{project.get_type_display}}</div> 
                    {% endif %}
                    <div class="text-2xl font-normal text-white mt-6 underline decoration-green-400">Connect with Creator</div>
                    <div class="flex flex-col gap-y-4 text-base">
                        <div class="inline-block">
                            <a href="{% url 'user_profile' project.creator.user.username %}" target="_blank">
                                <div class="relative w-20 h-20">
                                    <img src="{{ project.creator.profile_image.url }}?v={{ project.creator.updated_at.timestamp }}"
                                        class="w-20 h-20 rounded-lg object-cover border border-[#2d323b]">
                                    
                                    {% if project.creator.last_seen|is_online %}
                                        <span class="absolute bottom-1 right-1 w-3 h-3 bg-green-500 border-2 border-white rounded-full" title="Active"></span>
                                    {% endif %}
                                </div>
                            </a>
                        </div>
                        <div class="flex justify-between items-center gap-x-5">
                            <a href="{% url 'user_profile' project.creator.user.username %}" target="_blank" class="text-gray-300 hover:text-green-400 transition-colors"><i class="fa-regular fa-user"></i> &nbsp;<span class='hover:underline'>{{project.creator.user.first_name}} {{project.creator.user.last_name}}</span></a>
                            
                            {% if link_available %}
                                <div class="flex gap-x-5">
                                {% for link, url in social_link.items %}
                                    {% if url %}
                                    <a href='{{url}}' target='_blank'><i class="text-2xl cursor-pointer fa-brands fa-{{link}} text-gray-400 hover:text-green-400 transition-colors"></i></a>
                                    {% endif %}
                                {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% if project.creator.user.email %}
                        <a href="mailto:{{ project.creator.user.email }}" class="text-gray-300 hover:text-green-400 transition-colors"><i class="fa-regular fa-envelope"></i> &nbsp;<span class='hover:underline'>{{project.creator.user.email}}</span></a>
                        {% endif %}
                        
                        {% if project.creator.phone %}
                        <a href='tell:+{{project.creator.phone}}' class="text-gray-300 hover:text-green-400 transition-colors"><i class="fa-solid fa-phone"></i> &nbsp;<span class='hover:underline'>{{project.creator.phone}}</span></a>
                        {% endif %}
                        {%if project.creator.location%}
                        <div class="text-gray-400"><i class="fa-solid fa-map-marker-alt text-green-400"></i> &nbsp;{{project.creator.location}}</div>
                        {%endif%}
                    </div>

                    <a href="{% url 'project_joined_members' project.id %}" class="inline-flex items-center gap-2 font-medium text-gray-300 hover:text-green-400 transition duration-200">
                        <i class="fa-solid fa-users text-green-400"></i>
                        
                        <!-- Joined members count -->
                        <span id="membercount" class="text-base font-semibold text-white">{{ project.tot_member }}</span>
                        <span class='hover:underline'>Joined</span>

                        <!-- Pending requests (only for project creator) -->
                        {% if project.creator == request.user.info %}
                            <span class="ml-2 text-xs text-orange-400 font-semibold hover:underline transition">
                                {{ project.requested_users.count }} pending
                            </span>
                        {% else %}
                        <span class="ml-2 text-xs text-green-400 font-medium hover:underline transition">View</span>
                        {% endif %}
                    </a>

                
                    {% comment %} status  {% endcomment %}
                    {% if request.user.info in project.members.all or request.user.info in project.requested_users.all  %}
                        <div class="flex items-center gap-2 bg-green-600/20 border border-green-600 px-4 py-2 rounded-lg text-sm font-medium text-green-400 w-fit" id='show_status'>
                            <i class="fa-regular fa-clock text-base"></i>
                            <span class="text-green-400">Status:</span>
                            
                            {% if request.user.info in project.members.all %}
                                <span class="text-green-300 font-semibold tracking-wide">Joined</span>
                            {% elif request.user.info in project.requested_users.all %}
                                <span class="text-green-300 font-semibold tracking-wide">Pending</span>
                            {% endif %}
                        </div>
                    {% elif request.user.info in project.rejected_users.all %}
                        <div class="flex items-center gap-3 bg-red-800 border border-red-600 px-4 py-2.5 rounded-xl shadow-sm w-fit animate-fade-in">
                            <i class="fa-solid fa-circle-exclamation text-white text-lg sm:text-xl"></i>
                            <div class="flex flex-col leading-tight text-white">
                                <span class="text-sm sm:text-base font-medium">Request declined</span>
                                <span class="text-xs sm:text-sm">No worries! Try again after enhancing your skills âœ¨</span>
                            </div>
                        </div>
                    {% endif %}

                    <div class="flex gap-x-3 items-start bg-yellow-600/20 border border-yellow-600 px-4 py-3 mt-3 rounded-lg border-l-4 border-l-yellow-500" id='join_help_text_div' >
                        <i class="fa-solid fa-circle-info text-yellow-400 mt-1"></i>
                        {% if project.creator == request.user.info %}
                            <div class="text-sm text-gray-300">
                                <span class="font-semibold text-yellow-400">Note:</span> See who joined and connect with those you like.
                            </div>
                        {% else %}    
                            {% if request.user.info in project.members.all %}
                                <div class="text-sm text-gray-300">
                                    <span class="font-semibold"></span> <span id='join_help_text_div'>You're part of the team now ðŸš€ â€” Work together and make something great.</span>
                                </div>
                            {% else %}
                                <div class="text-sm text-gray-300">
                                    <span class="font-semibold"></span> <span id='join_help_text_div'>The creator will review and accept your request if interested.</span>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>

                    <div class="flex items-center justify-center gap-x-5">

                        {% if project.creator == request.user.info %}
                            <a href='{% url "project_joined_members" project.id %}' class="px-6 py-2 bg-gradient-to-br from-green-600 to-green-900 text-white border border-green-600 rounded-full transition hover:scale-110 shadow-lg">Manage Members</a>
                        {% else %} 
                            
                            {% if request.user.info in project.members.all %}
                                <button id="joinProjectBtn" class="px-6 py-2 bg-red-700 hover:bg-red-600 text-white rounded-full transition hover:scale-110 cursor-pointer shadow-lg" onclick="leaveProjectMembers({{ project.id }}); clickSound()">
                                    Leave Team
                                </button>
                            {% elif request.user.info in project.requested_users.all %}
                                <button id="joinProjectBtn"  class="px-6 py-2 bg-[#262b34] hover:bg-[#3a3f48] text-white border border-[#2d323b] rounded-full transition hover:scale-110 cursor-pointer shadow-lg" onclick="toggleJoinRequest({{ project.id }}); clickSound()">
                                    Cancel Request
                                </button>
                            {% else %}
                                <button id="joinProjectBtn"  class="px-6 py-2 bg-gradient-to-br from-green-600 to-green-900 hover:from-green-500 hover:to-green-800 text-white border border-green-600 rounded-full transition hover:scale-110 cursor-pointer shadow-lg" onclick="toggleJoinRequest({{ project.id }}); clickSound()" >
                                    Request to Join
                                </button>
                            {% endif %}

                        {% endif %}

                    </div>
                </div>

                <div class="w-full md:w-full">
                    <div>
                        <fieldset id = 'test' class="border border-[#2d323b] rounded-xl p-4 flex flex-col gap-y-4 bg-[#1a1f2b] shadow-xl">
                            <legend class="px-3 text-gray-400 text-md">Skills and Expertise</legend>
                            <div class="text-2xl font-bold text-white">Domain: <span class="text-green-400">{{project.domain.name}}</span></div>

                            {% if project.level %}
                            <div class="self-start">
                                <div class="border border-green-600 bg-green-600/20 px-3 py-2 rounded-lg text-green-400 font-medium">Level: {{project.get_level_display}}</div>
                            </div>
                            {% endif %}
                            
                            <div class="flex flex-col gap-y-3 rounded-lg">
                                <div class="text-gray-300 font-medium">Skills Needed</div>
                                <div class="flex gap-x-3 flex-wrap gap-y-2">
                                    {% for skill in skill_needed %}
                                    <div class="bg-green-600/20 w-fit px-3 border border-green-600 rounded-lg py-2 text-green-300 font-medium">{{skill.name}}</div>
                                    {% endfor %}                                    
                                </div>
                            </div>
                            <div>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>
        </div>

        
        <!-- comments section  -->
        <div class="m-auto w-[90%] lg:w-[900px] flex flex-col gap-y-4" id = "commentsection">
            <!-- text area and submit btn -->
            <div class="flex flex-col gap-y-3">
                <form method = 'post' id="commentForm" action='{% url "save_project_comment" project.id %}' class="flex flex-col gap-y-4">
                    {% csrf_token %}

                    <textarea name="content" id="commentTextArea"
                        class="h-44 outline-none p-4 border border-[#2d323b] bg-[#161b22] text-white placeholder:text-gray-400 rounded-xl focus:border-green-500 transition-colors"
                        required
                        placeholder="Share your thoughts about this project..."></textarea>
                    <button type="submit" class="self-end bg-gradient-to-br from-green-600 to-green-900 hover:from-green-500 hover:to-green-800 text-white px-6 py-2 rounded-lg transition hover:scale-105 shadow-lg">Submit</button>
                </form>
            </div><br>

            <!-- all comments section -->
            <div class="flex flex-col gap-y-4 bg-[#1a1f2b] border border-[#2d323b] rounded-xl shadow-xl" id='commentBox'>
                <div class="text-xl bg-gradient-to-br from-green-600 to-green-900 text-white p-4 rounded-t-xl text-center mb-2"> <span class="text-white"  id='total_comments'>{{project.tot_comments}}</span> Comments</div>
                
                <div id="commentList" class="flex flex-col gap-y-4 px-4 mt-2">
                    {% if comments %}
                    <!-- single comment -->
                    {% for comment in comments %}    
                    <div id="comment-{{ comment.id }}">
                        <!-- question -->
                        <div class="bg-[#262b34] border border-[#2d323b] shadow-lg w-[95%] md:w-3/4 px-5 py-4 rounded-2xl transition hover:shadow-xl hover:border-green-600/30 duration-300">
                            <!-- Header -->
                            <div class="flex gap-3 items-center relative mb-2">
                                <a href='{% url "user_profile" comment.user.user.username %}'><img src="{{ comment.user.profile_image.url }}?v={{ comment.user.updated_at.timestamp }}" alt="" class="w-10 h-10 rounded-lg ring-1 ring-[#2d323b] object-cover"></a>
                                <div>
                                    <a href='{% url "user_profile" comment.user.user.username %}'><p class="font-semibold text-sm text-white hover:text-green-400 transition-colors">{{ comment.user.user.first_name }} {{ comment.user.user.last_name }}</p></a>
                                    <p class="text-xs text-gray-400">{{ comment.created_at|date:"M j, Y" }}</p>
                                </div>
                                {% if comment.user == user.info %}
                                    <button class="absolute right-2 top-1 delete-project-comment cursor-pointer" data-id="{{ comment.id }}" data-type="project_comment" title="Delete">
                                        <img src="{% static 'assets/trash-bin.svg' %}" class="h-5 w-5 opacity-70 hover:opacity-100 transition filter invert">
                                    </button>
                                {% endif %}
                            </div>

                            <!-- Content -->
                            <div class="text-sm text-gray-300 mb-4 whitespace-pre-line leading-relaxed">
                                {{ comment.content|linebreaksbr }}
                            </div>

                            <!-- Actions -->
                            <div class="flex justify-between items-center text-sm">
                                <div class="flex items-center gap-4">
                                    <!-- Like (placeholder) -->
                                    <button class="flex items-center gap-1 text-gray-400 hover:text-green-400 comment-container cursor-pointer transition-colors" data-comment-id="{{ comment.id }}">
                                        <i class="fa-solid fa-thumbs-up {% if user.info in comment.likes.all %}text-green-400{% endif %}"></i>
                                        <span>{{comment.total_likes}}</span>
                                    </button>

                                    <!-- Hide/Show replies (UI only) -->
                                    <button class="text-gray-400 hover:text-white font-semibold transition text-xs lg:text-sm"
                                            onclick="toggleReplies({{ comment.id }}, this, {{ comment.replies.count }})">
                                        <i class="fa-solid fa-chevron-down text-xs"></i> Show Replies (<span id="show_reply_count_{{ comment.id }}">{{ comment.replies.count }}</span>)
                                    </button>
                                </div>

                                <!-- Reply -->
                                <div class="bg-gradient-to-br from-green-600 to-green-900 hover:from-green-500 hover:to-green-800 text-white inline-flex items-center gap-2 rounded-lg text-sm font-medium transition hover:scale-[1.03] shadow-lg px-4 py-2 cursor-pointer" onclick="toggleReplyForm({{ comment.id }})">    
                                    <i class="fa-solid fa-paper-plane text-xs"></i> Reply
                                </div>
                            </div>
                        </div>
                        <!-- question end -->

                        {% comment %} reply form {% endcomment %}
                        <div id="reply-form-{{ comment.id }}" class="w-[95%] md:w-3/4 ml-auto my-4 hidden">
                            <form method="POST" action="{% url 'save_project_reply' %}" data-comment-id="{{ comment.id }}" class="bg-[#262b34] border border-[#2d323b] p-5 rounded-xl duration-200 reply-form shadow-lg">
                                {% csrf_token %}
                                <input type="hidden" name="comment_id" value="{{ comment.id }}">

                                <label for="reply_content_{{ comment.id }}" class="block text-sm font-medium text-gray-300 mb-2">
                                    Write a reply
                                </label>
                                <textarea id="reply_content_{{ comment.id }}" name="reply_content" rows="4"
                                        placeholder="Share your thoughts..."
                                        required
                                        class="w-full resize-none border border-[#2d323b] bg-[#161b22] text-white placeholder:text-gray-400 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"></textarea>
                                
                                <div class="flex justify-end mt-3">
                                    <button type="submit"
                                        class="inline-flex items-center gap-2 bg-gradient-to-br from-green-600 to-green-900 hover:from-green-500 hover:to-green-800 text-white px-5 py-1.5 rounded-lg text-sm font-medium transition hover:scale-[1.03] shadow-lg">
                                        <i class="fa-solid fa-paper-plane text-xs"></i> Submit
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- reply section -->
                        <div class="flex gap-x-2 mb-4 mt-2">
                            <!-- Left vertical bar -->
                            <div class="bg-gradient-to-b from-green-600 to-green-900 w-2 ml-5 rounded-full"></div>

                            <!-- Replies container -->
                            <div class="flex flex-col gap-y-4 ml-auto w-full" id="replies-for-{{ comment.id }}" style="display: none;">
                                {% for reply in comment.replies.all %}
                                <div id="reply-{{ reply.id }}"
                                    class="ml-auto max-w-[95%] md:max-w-[75%] bg-[#161b22] border border-[#2d323b] px-4 py-3 rounded-lg flex flex-col gap-y-2 relative transition shadow-lg hover:border-green-600/30">

                                    <!-- Header -->
                                    <div class="flex items-center gap-3">
                                        <a href='{% url "user_profile" reply.user.user.username %}' class='flex items-center gap-3'>
                                            <img src="{{ reply.user.profile_image.url }}?v={{ reply.user.updated_at.timestamp }}" alt=""
                                            class="w-10 h-10 rounded-lg object-cover ring-1 ring-[#2d323b]">
                                            <p class="font-semibold text-sm text-white hover:text-green-400 pr-10 transition-colors">{{ reply.user.user.first_name }} {{ reply.user.user.last_name }}</p>
                                        </a>

                                        {% if reply.user == user.info %}
                                        <button class="absolute right-2 top-2 delete-reply-comment" data-id="{{ reply.id }}" data-type="project_reply" title="Delete Reply">
                                            <img src="{% static 'assets/trash-bin.svg' %}" class="h-5 w-5 opacity-70 hover:opacity-100 transition cursor-pointer filter invert">
                                        </button>
                                        {% endif %}
                                    </div>

                                    <!-- Content -->
                                    <div class="text-sm text-gray-300 whitespace-pre-line leading-relaxed">
                                        {{ reply.content|linebreaksbr }}
                                    </div>

                                    <!-- Footer -->
                                    <div class="flex justify-between items-center mt-1 text-xs text-gray-400">
                                        <p>{{ reply.created_at|date:"M j, Y" }}</p>

                                        <!-- Like (visual only) -->
                                        <button class="flex items-center gap-1 text-gray-400 hover:text-green-400 reply-container cursor-pointer transition-colors" data-reply-id="{{ reply.id }}">
                                            <i class="fa-solid text-base fa-thumbs-up {% if user.info in reply.likes.all %}text-green-400{% endif %}"></i>
                                            <span class='text-base'>{{reply.total_likes}}</span>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class='flex flex-col gap-y-8 px-3' id='noCommentSVG'>
                        <div class="flex flex-col items-center justify-center py-8">
                            <div class="w-20 h-20 mb-4 bg-gradient-to-br from-green-500/20 to-green-700/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-comments text-2xl text-green-400"></i>
                            </div>
                            <p class='text-center text-lg text-gray-300 pb-5'>No comments yet...</p>
                            <div class="w-12 h-0.5 bg-gradient-to-r from-green-500 to-green-700 rounded-full"></div>
                        </div>
                    </div>
                    {% endif %}
                </div>

            </div>
        </div>

    </div>

    {% include "includes/create-post.html" %}
    <script src="{% static 'scripts/jquery-3.7.1.min.js' %}"></script>
    <script src="{% static 'scripts/collaboration_project.js' %}"></script>

{% endblock  %}